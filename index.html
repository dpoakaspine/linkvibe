<html>
  <head>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    <script src="lib/zepto.min.js"></script>
    <script src="lib/animate.js"></script>
    <script src="lib/data.js"></script>
    <script src="lib/firebase.js"></script>
  </head>

  <body>
    <div class="container">
     <ul id="save">

    </ul>
    </div>
  </body>


  <script>
  $(function() {

  var userid = window.location.hash.substring(1);
  console.log('userid: '+userid);

  var appdb = new Firebase("https://dpoakaspinechromext.firebaseio.com/user/"+userid+"/saves/");

  /*
  for(var index in appdb) {
      var attr = appdb[index];
      console.log(attr);
  }


  appdb.on("value", function(snap) {
      console.log('new record', snap.key());
      var ssnap = snap.val();
      //alert( ssnap.url );
      console.log(ssnap);
      $('#save').append('<li><h2>'+snap.key()+'</h2></li>');
  });
  */

  /*
  appdb.on("value", function(snap) {
      console.log('new record', snap.key());
      var ssnap = snap.val();
      //alert( ssnap.url );
      $('#save').append('<li><a target="_blank" href="'+ssnap.url+'">'+ssnap.title+'</a></li>');
  });
  */

  appdb.once("value", function(snapshot) {

    //$('#save li').hide();

    // The callback function will get called twice, once for "fred" and once for "barney"
    snapshot.forEach(function(childSnapshot) {
      console.log(childSnapshot.key());
      $('#save').append('<li><h2>'+childSnapshot.key()+'</h2></li>');
      // key will be "fred" the first time and "barney" the second time
      var key = childSnapshot.key();
      // childData will be the actual contents of the child
      var childData = childSnapshot.val();
      console.log(childData);
      var linkdb = new Firebase("https://dpoakaspinechromext.firebaseio.com/user/"+userid+"/saves/"+key+"/");
      linkdb.on("value", function(linksnapshot) {
          //console.log(linksnapshot.val());
          var link = linksnapshot.val();
          console.log(link);
          //$('#save').append('<li><a target="_blank" href="'+link.url+'">'+link.title+'</a></li>');
      });

      for(var index in childData) {
          var link = childData[index];

          var a = document.createElement('a');
          a.href = link.url;
          var domain = a.hostname;


          $('#save').append('<li class=""><a target="_blank" data-action="'+ key +'" data-item="'+ index +'" href="'+link.url+'"><i class="fa fa-check delete"></i> &nbsp;<img src="http://www.google.com/s2/favicons?domain='+domain+'" class="favicon grey" height="15" /> '+link.title+'</a></li>');
          console.log(index);

      }

      //console.log(childData);
    });

    $('.delete').on('click', function(e) {
        $(this).parent().parent().addClass('checked');
        $(this).removeClass('fa-check delete').addClass('fa-flag');
        var index = $(this).parent().data('item');
        var action = $(this).parent().data('action');
        var deletedb = new Firebase("https://dpoakaspinechromext.firebaseio.com/user/"+userid+"/saves/"+action+"/"+index+"/").remove();
        return false;
        e.preventDefault;
    });

    $('#save li a').on('mouseenter', function(e) {
        $(this).find('.favicon').removeClass("grey");
    }).on('mouseleave', function(e) {
        $(this).find('.favicon').addClass("grey");
    });

  });

  });
  </script>

</html>
